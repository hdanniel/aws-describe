- hosts: ansible
  connection: local
  vars:
    aws_regions: 
    - us-east-1
    - us-west-1
    - us-west-2
  tasks:
  - name: create dirs
    file: path="{{ inv_dir }}/{{ item }}" state=directory
    with_items: "{{ aws_regions }}"
  - name: describe-instances
    shell: "aws ec2 describe-instances --profile {{ aws_profile }}  --region {{ item }} |  jq '.Reservations|=sort_by(.ReservationId)|.Reservations[].Instances|=sort_by(.InstanceId)' > {{ inv_dir }}/{{ item }}/instances.json"
    with_items: "{{ aws_regions }}"
  - name: describe-groups
    shell: "aws ec2 describe-security-groups --profile {{ aws_profile }} --region {{ item }} | jq '.SecurityGroups|=sort_by(.GroupId)'  > {{ inv_dir }}/{{ item }}/groups.json"
    with_items: "{{ aws_regions }}"
  - name: describe-volvumes
    shell: "aws ec2 describe-volumes --profile {{ aws_profile }} --region {{ item }} | jq '.Volumes|=sort_by(.CreateTime)' > {{ inv_dir }}/{{ item }}/volumes.json"
    with_items: "{{ aws_regions }}"
  - name: describe-elb
    shell: "aws elb describe-load-balancers --profile {{ aws_profile }} --region {{ item }} |  jq '.LoadBalancerDescriptions|=sort_by(.CreatedTime)'  > {{ inv_dir }}/{{ item }}/elbs.json"
    with_items: "{{ aws_regions }}"
